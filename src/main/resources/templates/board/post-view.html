<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Google fonts-->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="../../css/main.css" rel="stylesheet" />
    <link href="../../css/board.css" rel="stylesheet" />
    <title>ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€</title>
</head>

<body>
<!-- Header -->
<div th:replace="~{header :: header}"></div>

<div class="post-view-container">

    <table class="post-table">
        <h2 class="post-title" th:text="${board.subject}"></h2>
        <tr>
            <th>ì‘ì„±ì</th>
            <td class="post-author" th:text="${board.member.nickname}"></td>
        </tr>
        <tr>
            <th>ì‘ì„±ì¼</th>
            <td class="post-date" th:text="${#temporals.format(board.createDate, 'yyyy-MM-dd HH:mm')}"></td>
        </tr>
        <tr>
            <th>ì¡°íšŒìˆ˜</th>
            <td class="post-views" th:text="${board.viewCount}"></td>
        </tr>
    </table>

    <div class="post-content">
        <p th:text="${board.content}"></p>
        <img th:if="${board.filePath}" th:src="@{${board.filePath}}" alt="ì²¨ë¶€íŒŒì¼">
    </div>


    <!-- ì¶”ì²œ ë²„íŠ¼ -->
    <div class="like-container">
        <div class="like-box" onclick="likePost()">
            <i class="like-img"><img src="../../img/like-icon.png" alt=""></i>
            <span>ì¶”ì²œ</span>
            <span id="likeCount" th:text="${board.likeCount}"></span>
        </div>
    </div>


    <div class="post-button-group">
        <th:block th:if="${board != null}">
            <!-- âœ… ì‘ì„±ìë§Œ ìˆ˜ì • ë²„íŠ¼ì„ ë³¼ ìˆ˜ ìˆë„ë¡ ì„¤ì • -->
            <th:block th:if="${#authentication.name == board.member.id}">
                <button class="post-edit-btn" th:data-edit-url="@{/board/edit/{id}(id=${board.boardId})}"
                        onclick="redirectToEdit(this)">ìˆ˜ì •</button>
            </th:block>

            <!-- âœ… ì‘ì„±ìë§Œ ì‚­ì œ ë²„íŠ¼ì„ ë³¼ ìˆ˜ ìˆë„ë¡ ì„¤ì • -->
            <th:block th:if="${#authentication.name == board.member.id}">
                <form th:action="@{/board/delete/{id}(id=${board.boardId})}" method="post"
                      onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" class="post-delete-btn">ì‚­ì œ</button>
                </form>
            </th:block>
        </th:block>
        <button class="post-cancel-btn" onclick="history.back()">ëª©ë¡ë³´ê¸°</button>
    </div>


    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <div class="comment-section">

        <h3 id="commentCount">ëŒ“ê¸€</h3>

        <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ -->
        <div class="comment-input">
            <textarea id="commentText" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <button class="comment-submit" onclick="addComment()">ë“±ë¡</button>
        </div>
    </div>


        <!-- ê¸°ì¡´ ëŒ“ê¸€ ëª©ë¡ -->
        <div class="comment-list" id="commentList">
            <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
        </div>
    </div>

</div>

<!-- Footer -->
<div class="footer" style="width: 100%">
<div  th:replace="~{footer :: footer}"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        loadComments();
    });

    // âœ… ê²Œì‹œê¸€ ì¶”ì²œ ê¸°ëŠ¥
    function likePost() {
        const boardId = window.location.pathname.split("/").pop();

        fetch(`/board/like/${boardId}`, {
            method: "POST"
        })
            .then(response => response.text())
            .then(message => {
                if (message.includes("ë°˜ì˜")) {
                    let likeCountElement = document.getElementById("likeCount");
                    likeCountElement.innerText = parseInt(likeCountElement.innerText) + 1;
                    alert("ì¶”ì²œì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else if (message.includes("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤")) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                } else {
                    alert("ì´ë¯¸ ì¶”ì²œí•œ ê²Œì‹œë¬¼ì…ë‹ˆë‹¤.");
                }
            })
            .catch(error => console.error("ğŸš¨ ì¶”ì²œ ì˜¤ë¥˜:", error));
    }




   // âœ… ê²Œì‹œê¸€ ì‚­ì œ
    function deletePost(button) {
       const url = button.getAttribute('data-delete-url');
       if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
           fetch(url, { method: 'DELETE' })
               .then(response => {
                   if (response.ok) {
                       alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                       window.location.href = "/board"; // ì‚­ì œ í›„ ëª©ë¡ìœ¼ë¡œ ì´ë™
                   } else {
                       alert("ì‚­ì œ ì‹¤íŒ¨.");
                   }
               })
               .catch(error => console.error("ğŸš¨ ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:", error));
       }
   }


   // âœ… ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
   function loadComments() {
       const boardId = window.location.pathname.split("/").pop();

       fetch(`/api/remarks/${boardId}`)
           .then(response => response.json())
           .then(comments => {
               // 1) ë¶€ëª¨ ëŒ“ê¸€ê³¼ ìì‹ ëŒ“ê¸€ ë¶„ë¦¬
               const parents = comments.filter(c => c.parentId === null);
               const children = comments.filter(c => c.parentId !== null);

               const commentList = document.getElementById("commentList");
               commentList.innerHTML = "";// 2) ë¶€ëª¨ ëŒ“ê¸€ ê·¸ë¦¬ê¸°
               parents.forEach(parent => {
                   commentList.innerHTML += renderComment(parent);// 3) í•´ë‹¹ ë¶€ëª¨ì— ì—°ê²°ëœ ìì‹ë“¤ë§Œ ê³¨ë¼ì„œ
                   const childComments = children.filter(child => child.parentId === parent.id);// 4) ë¶€ëª¨ ëŒ“ê¸€ì˜ reply-sectionì— ìì‹(ëŒ€ëŒ“ê¸€)ì„ ê·¸ë¦°ë‹¤
                   const replySection = document.getElementById(`reply-section-${parent.id}`);
                   childComments.forEach(child => {
                       replySection.innerHTML += renderChildComment(child);
                   });
               });
           })
           .catch(error => console.error("ğŸš¨ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
   }





  // (1) ê¸°ì¡´ ë¶€ëª¨ ëŒ“ê¸€ ë Œë”ë§ í•¨ìˆ˜
  function renderComment(comment) {
      // comment.memberId === í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì id
      const isOwner = (comment.memberId === currentUserId);

      return `
  <div class="comment" id="comment-${comment.id}">
      <span class="comment-author">${comment.author}</span>
      <span class="comment-date">${new Date(comment.createdDate).toLocaleString()}</span>
      <p class="comment-content">${comment.content}</p>
      <div class="comment-actions">
          ${
          isOwner
              ? `
                  <button class="comment-edit-btn" onclick="editComment('${comment.id}', '${comment.content}')">ìˆ˜ì •</button>
                  <button class="comment-delete-btn" onclick="deleteComment('${comment.id}')">ì‚­ì œ</button>
                `
              : ''
      }

          <button class="comment-add-btn" onclick="showReplyForm('${comment.id}')">ë‹µê¸€</button>

          <button class="comment-like-btn" id="likeButton-${comment.id}" onclick="likeComment('${comment.id}')">
              ì¶”ì²œ (${comment.likeCount ?? 0})
          </button>
      </div>

      <div class="reply-section" id="reply-section-${comment.id}"></div>
  </div>`;
  }



    // (2) ê¸°ì¡´ ìì‹ ëŒ“ê¸€(ëŒ€ëŒ“ê¸€) ë Œë”ë§ í•¨ìˆ˜
    function renderChildComment(comment) {
        const isOwner = (comment.memberId === currentUserId);

        return `
    <div class="comment child-comment" id="comment-${comment.id}" style="margin-left: 30px;">
        <span class="comment-author">${comment.author}</span>
        <span class="comment-date">${new Date(comment.createdDate).toLocaleString()}</span>
        <p class="comment-content">${comment.content}</p>
        <div class="comment-actions">
            ${
            isOwner
                ? `
                    <button class="comment-edit-btn" onclick="editComment('${comment.id}', '${comment.content}')">ìˆ˜ì •</button>
                    <button class="comment-delete-btn" onclick="deleteComment('${comment.id}')">ì‚­ì œ</button>
                  `
                : ''
        }
            <button class="comment-like-btn" id="likeButton-${comment.id}" onclick="likeComment('${comment.id}')">
                ì¶”ì²œ (${comment.likeCount ?? 0})
            </button>
        </div>
    </div>`;
    }




    // âœ… ëŒ“ê¸€ ì‘ì„±
    function addComment(parentId = null) {
        console.log(">>> isAuthenticated in post-view: ", isAuthenticated);
        console.log(">>> currentUserId in post-view: ", currentUserId);
        if (!isAuthenticated) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        const boardId = window.location.pathname.split("/").pop();
        const textArea = parentId
            ? document.getElementById(`replyText-${parentId}`)
            : document.getElementById("commentText");
        const content = textArea.value.trim();

        if (content === "") {
            alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const params = new URLSearchParams();
        params.append("boardId", boardId);
        params.append("content", content);

        if (parentId !== null && parentId !== undefined) {
            params.append("parentRemarkId", parentId);
        }

        fetch("/api/remarks/write", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params
        })
            .then(response => {
                // ì‘ë‹µ ìƒíƒœ ì½”ë“œê°€ 2xx(ì„±ê³µ)ê°€ ì•„ë‹ˆë©´ ì—ëŸ¬ë¡œ ì·¨ê¸‰
                if (!response.ok) {
                    if (response.status === 401) {
                        // 401ì´ë©´ "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." ì•ˆë‚´
                        throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    }
                    // ê·¸ ì™¸ ì—ëŸ¬ ìƒí™©
                    throw new Error("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
                }
                // ì •ìƒ ì‘ë‹µì´ë©´ bodyë¥¼ text()ë¡œ ë³€í™˜
                return response.text();
            })
            .then(message => {
                // ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ë©´ ì„±ê³µ
                alert("ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                textArea.value = "";  // ì…ë ¥ì°½ ì´ˆê¸°í™”
                loadComments();
            })
            .catch(error => console.error("ğŸš¨ ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:", error));
    }

    function editComment(remarkId, content) {
        if (!isAuthenticated) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }


        // í˜„ì¬ ëŒ“ê¸€ ì˜ì—­ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const commentDiv = document.getElementById(`comment-${remarkId}`);
        const contentP = commentDiv.querySelector('.comment-content');
        const commentActions = commentDiv.querySelector('.comment-actions');

        // ì´ë¯¸ í¸ì§‘ì°½ì´ ì—´ë ¤ ìˆìœ¼ë©´ ì¤‘ë³µ ìƒì„±í•˜ì§€ ì•ŠìŒ
        if (commentDiv.querySelector('.edit-container')) {
            return;
        }

        // ê¸°ì¡´ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
        const originalContent = contentP.innerText;
        contentP.style.display = "none";
        // ë²„íŠ¼ ìˆ¨ê¹€ ì²˜ë¦¬
        if (commentActions) {
            commentActions.style.display = 'none';
        }

        // í¸ì§‘ì°½ ì»¨í…Œì´ë„ˆ ìƒì„± (ì¸ë¼ì¸ìœ¼ë¡œ ë³´ì´ë„ë¡)
        const editContainer = document.createElement('div');
        editContainer.className = 'edit-container';
        editContainer.style.marginTop = '10px';

        // textarea ìƒì„±
        const textArea = document.createElement('textarea');
        textArea.value = originalContent;
        textArea.style.width = '100%';
        textArea.style.boxSizing = 'border-box';
        // í´ë˜ìŠ¤ ì¶”ê°€
        textArea.classList.add('custom-textarea');

        // ì €ì¥ ë²„íŠ¼ ìƒì„±
        const saveButton = document.createElement('button');
        saveButton.innerText = "ì €ì¥";
        saveButton.style.marginRight = "5px";
        // í´ë˜ìŠ¤ ì¶”ê°€
        saveButton.classList.add('custom-save-btn');
        saveButton.addEventListener('click', function() {
            const newContent = textArea.value.trim();
            if (newContent === "") {
                alert("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            // PUT ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ìˆ˜ì • ë‚´ìš© ì „ì†¡
            fetch(`/api/remarks/edit/${remarkId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ content: newContent })
            })
                .then(() => loadComments()) // ìˆ˜ì • í›„ ì „ì²´ ëŒ“ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                .catch(error => console.error("ğŸš¨ ëŒ“ê¸€ ìˆ˜ì • ì˜¤ë¥˜:", error));
        });

        // ì·¨ì†Œ ë²„íŠ¼ ìƒì„±
        const cancelButton = document.createElement('button');
        cancelButton.innerText = "ì·¨ì†Œ";
        // í´ë˜ìŠ¤ ì¶”ê°€
        cancelButton.classList.add('custom-cancel-btn');
        cancelButton.addEventListener('click', function() {
            // í¸ì§‘ì°½ ì œê±° ë° ì›ë³¸ ë‚´ìš© ë³µì›
            editContainer.remove();
            contentP.style.display = "block";
            if (commentActions) {
                commentActions.style.display = 'block';
            }
        });

        // í¸ì§‘ì°½ì— textareaì™€ ë²„íŠ¼ ì‚½ì…
        editContainer.appendChild(textArea);
        editContainer.appendChild(saveButton);
        editContainer.appendChild(cancelButton);

        // ì›ë³¸ í…ìŠ¤íŠ¸ ë°”ë¡œ ì•„ë˜ì— í¸ì§‘ì°½ ì‚½ì…
        commentDiv.insertBefore(editContainer, contentP.nextSibling);
    }

    function deleteComment(remarkId) {
        if (!isAuthenticated) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        if (confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch(`/api/remarks/delete/${remarkId}`, { method: "DELETE" })
                .then(() => loadComments())
                .catch(error => console.error("ğŸš¨ ëŒ“ê¸€ ì‚­ì œ ì˜¤ë¥˜:", error));
        }
    }




    // âœ… ëŒ“ê¸€ ì¢‹ì•„ìš” ì¦ê°€
    function likeComment(remarkId) {
        if (!isAuthenticated) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        fetch(`/api/remarks/like/${remarkId}`, {
            method: 'POST'
        })
            .then(response => response.text())
            .then(message => {
                if (message.includes("ë°˜ì˜")) {
                    alert("ì¶”ì²œí•˜ì˜€ìŠµë‹ˆë‹¤.");
                    const likeButton = document.getElementById(`likeButton-${remarkId}`);
                    if (likeButton) {
                        let regex = /ì¶”ì²œ \((\d+)\)/;
                        let match = likeButton.innerText.match(regex);
                        if (match && match[1]) {
                            let count = parseInt(match[1], 10);
                            count++;
                            likeButton.innerText = `ì¶”ì²œ (${count})`;
                        }
                    }
                } else if (message.includes("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤")) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                } else {
                    alert("ì´ë¯¸ ì¶”ì²œí•œ ëŒ“ê¸€ì…ë‹ˆë‹¤.");
                }
            })
            .catch(error => console.error("ğŸš¨ ëŒ“ê¸€ ì¶”ì²œ ì˜¤ë¥˜:", error));
    }








    // âœ… ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼
    function showReplyForm(parentId) {
        if (!isAuthenticated) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        const replySection = document.getElementById(`reply-section-${parentId}`);
        replySection.innerHTML = `
        <textarea class="comment-textarea" id="replyText-${parentId}" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <div class="reply-button-group">
            <button class="comment-submit-btn" onclick="addComment('${parentId}')">ë“±ë¡</button>
            <button class="comment-submit-btn" onclick="cancelReply('${parentId}')">ì·¨ì†Œ</button>
        </div>
    `;
    }


    function cancelReply(parentId) {
        // ë‹µê¸€ ì…ë ¥í¼ ì œê±°
        const replySection = document.getElementById(`reply-section-${parentId}`);
        replySection.innerHTML = "";
    }


    // âœ… ëŒ€ëŒ“ê¸€ ì‘ì„±
    function addReply(parentId) {
        const boardId = window.location.pathname.split("/").pop();
        const content = document.getElementById(`replyText-${parentId}`).value;

        if (content.trim() === "") {
            alert("ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }


        fetch("/api/remarks/write", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                boardId: boardId,
                content: content,
                parentRemarkId: parentId  // âœ… ë¶€ëª¨ ëŒ“ê¸€ ID ì „ë‹¬
            })
        })
            .then(response => response.text())
            .then(message => {
                alert(message);
                loadComments(); // âœ… ëŒ€ëŒ“ê¸€ë„ ë‹¤ì‹œ ë¡œë“œ
            })
            .catch(error => console.error("ğŸš¨ ëŒ€ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:", error));
    }

    function redirectToEdit(button) {
        const editUrl = button.getAttribute("data-edit-url");
        console.log(">>> ìˆ˜ì • í˜ì´ì§€ ì´ë™ URL:", editUrl);
        window.location.href = editUrl;
    }



</script>



</body>
</html>
